<!DOCTYPE html>
<html>
    <head>
        <script src="jquery-1.6.2.min.js" type="text/javascript"></script>
        <script src="images.js" type="text/javascript"></script>
        <script src="shared.js" type="text/javascript"></script>
        <style type="text/css">
            #layers
            {
                border: 1px solid blue;
            }
            
            .layer
            {
                border: 1px solid black;
                padding: 5px;
            }
            
            .layer checkbox
            {
                padding-right: 10px;
            }
            
            .layer .delete
            {
                float: right;
            }
        </style>
    </head>
    <body>
        Opacity: <a href="" id="opless" class="ppbutton"><</a>
                 <input type="text" id="opacity" size="1" maxlength="3" value="0.5" readonly/>
                 <a href="" id="opmore" class="ppbutton">></a><br/>
        X: <a href="" id="xless" class="ppbutton"><</a>
           <input type="text" class="coords" id="coordX" value="50" size="2" maxlength="4"/>
           <a href="" id="xmore" class="ppbutton">></a><br/>
        Y:  <a href="" id="yless" class="ppbutton"><</a>
            <input type="text" class="coords" id="coordY" value="50" size="2" maxlength="4"/>
            <a href="" id="ymore" class="ppbutton">></a>

        <br /><br />
        Layers:
        <div id="layers"></div>

        Add new layer:
        <div>
            <input type="file" onchange="upload(this.files, this)" accept="image/*" />
        </div>
        <div>
            <input type="button" value="Show/Hide" onclick="sendToggleOverlay();" />
            <input type="button" value="Render" onclick="renderLayers();setCurrentLayer(GlobalStorage.get_CurrentOverlayId());" />
        </div>

        <script type="text/javascript">
            chrome.tabs.executeScript(null, { file: "jquery-1.6.2.min.js" }, function () {
                chrome.tabs.executeScript(null, { file: "jquery-ui-1.8.16.custom.min.js" }, function () {
                    chrome.tabs.executeScript(null, { file: "content.js" }, function () {
                        chrome.tabs.executeScript(null, { file: "images.js" });
                    });
                });
            });

            $(function () {
                renderLayers();

                $('input[name="selectedLayer"]').live('click', function () {
                    // Live handler called.
                    var overlayId = $(this).parents('.layer').data('Id');
                    setCurrentLayer(overlayId);
                });
            });

            // Layers
            var renderLayers = function () {
                var container = $('#layers');
                container.empty();
                var overlays = PPStorage.GetOverlays();
                for (var i = 0; i < overlays.length; i++) {
                    renderLayer(overlays[i]);
                }
                setCurrentLayer(GlobalStorage.get_CurrentOverlayId());
            }

            var renderLayer = function (overlay) {
                var container = $('#layers');
                var layer = $('<div></div>', {
                    class: 'layer',
                    data: {
                        Id: overlay.Id
                    }
                });
                var thumbHeight = 50;
                var coeff = overlay.Height / thumbHeight;
                var thumbWidth = Math.ceil(overlay.Width / coeff);
                var thumb = $('<img />', {
                    class: 'thumb',
                    src: overlay.Url,
                    css: {
                        width: thumbWidth + 'px',
                        height: thumbHeight + 'px'
                    }
                });

                layer.append($('<input type=checkbox name="selectedLayer" />'));
                layer.append(thumb);
                layer.append($('<input type=button class="delete" value="X" onclick="deleteLayer($(this).parents(\'.layer\'));" />'));
                container.append(layer);
            }

            var deleteLayer = function (layer) {
                if (confirm('Are you sure want to delete layer?')) {
                    var overlayId = $(layer).data('Id');
                    PPStorage.DeleteOverlay(overlayId);

                    renderLayers();

                    var overlaysCount = PPStorage.GetOverlaysCount();
                    if (overlaysCount > 0 && overlaysCount <= GlobalStorage.get_CurrentOverlayId()) {
                        setCurrentLayer(GlobalStorage.get_CurrentOverlayId() - 1);
                    }
                    else if(overlaysCount == 0) {
                        sendHideOverlay();
                        GlobalStorage.set_CurrentOverlayId(null);
                    }
                }
            }

            var setCurrentLayer = function (overlayId) {
                if (PPStorage.GetOverlaysCount() == 0)
                    return;

                if (!overlayId || overlayId==null)
                    overlayId = 0;

                $('input[name="selectedLayer"]').removeAttr('checked');
                $('input[name="selectedLayer"]').filter(function () {
                    return $(this).parents('.layer').data("Id") == overlayId
                }).attr('checked', 'checked');

                GlobalStorage.set_CurrentOverlayId(overlayId);
                refreshCoords();
                sendShowOverlay();
            }

            // end Layers

            var refreshCoords = function () {
                var overlay = PPStorage.GetOverlay(GlobalStorage.get_CurrentOverlayId());
                if (overlay != null) {
                    $('#coordX').val(overlay.X);
                    $('#coordY').val(overlay.Y);
                    $('#opacity').val(Number(overlay.Opacity).toFixed(1));
                }
            }

            function upload(files, uploadElem) {
                file = files[0];

//                for (var i = 0; i < files.length; i++) {
//                    file = files[i];
//                    if (window.createObjectURL) {
//                        url = window.createObjectURL(file)
//                    } else if (window.createBlobURL) {
//                        url = window.createBlobURL(file)
//                    } else if (window.URL && window.URL.createObjectURL) {
//                        url = window.URL.createObjectURL(file)
//                    } else if (window.webkitURL && window.webkitURL.createObjectURL) {
//                        url = window.webkitURL.createObjectURL(file)
//                    }
//                }

                PPStorage.SaveOverlayFromFile(file,
                    function (overlay) {
                        $($(uploadElem).parent()).html($(uploadElem).parent().html()); // Hack Clear file upload

                        if (overlay == null)
                            return;
                        renderLayer(overlay);

                        if (!GlobalStorage.get_CurrentOverlayId() || PPStorage.GetOverlaysCount() == 1)
                            setCurrentLayer(overlay.Id);
                    });
            }

            // Overlay commands
            function sendToggleOverlay() {
                sendOverlayCommand('toggleOverlay');
            }

            function sendShowOverlay() {
                sendOverlayCommand('createOverlay');
            }

            function sendHideOverlay() {
                chrome.tabs.executeScript(null, {
                    code: 'removeOverlay();'
                });
            }

            function sendOverlayCommand(funcName) {
                var overlay = PPStorage.GetOverlay(GlobalStorage.get_CurrentOverlayId());
                if (overlay == null)
                    return;

                //var funcName = createOnly ? "createOverlay" : "toggleOverlay";
                chrome.tabs.executeScript(null, {
                    code:
                        funcName + "(); $('#overlay_3985123731465987').attr('src', ''); $('#overlay_3985123731465987').attr('src', '" + overlay.Url + "')" + //";"
                                ".css('width','" + overlay.Width + "px').css('height','" + overlay.Height + "px')" +
                                ".css('left','" + overlay.X + "px').css('top','" + overlay.Y + "px')" +
                                ".css('opacity'," + overlay.Opacity + ");"
                });
            }


        </script>
        <script type="text/javascript">
//            chrome.extension.onRequest.addListener(
//                function(request,sender,sendResponse){
//                    alert(request.coordX);
//                }
//            );
            
            $('.ppbutton').live("click",function(event){
                event.preventDefault();
                if($(this).attr('id')=="opless" || $(this).attr('id')=="opmore"){
                    opacity($(this));
                }
                if($(this).attr('id')=="xless" || $(this).attr('id')=="xmore"){
                    xleft($(this));
                }
                if($(this).attr('id')=="yless" || $(this).attr('id')=="ymore"){
                   xtop($(this));
                }
            });

            $('.coords').live("keypress", function (event) {
                if (event.which == 13) {
                    if ($(this).attr("id") == "coordX")
                        change(false, $(this).val(), false);
                    if ($(this).attr("id") == "coordY")
                        change(false, false, $(this).val());
                }
            });

            var opacity = function(button){
                var offset=0;
                if(button.attr('id') == "opless"){ 
                    if($('input#opacity').val()>=0.11)
                        offset= 0.1;
                    else offset = 0;
                }
                else{
                    if($('input#opacity').val()<=0.99)
                        offset = -0.1;
                    else offset = 0;
                }
                var thisOpacity = Number($('input#opacity').val() - offset).toFixed(1);
                $('input#opacity').val(thisOpacity);
                change(thisOpacity,false,false);
            }
            
            var xleft = function(button){
                var offset=0;
                if(button.attr('id') == "xless"){ 
                    if($('input#coordX').val()>=0)
                        offset= 1;
                    else offset = 0;
                }
                else{
                    offset = -1;
                }
                var thisX = $('input#coordX').val()-offset;
                $('input#coordX').val(thisX);
                change(false,thisX,false);
            }
            
            var xtop = function(button){
                var offset=0;
                if(button.attr('id') == "yless"){ 
                    if($('input#coordY').val()>=0)
                        offset= 1;
                    else offset = 0;
                }
                else{
                    offset = -1;
                }
                var thisY = $('input#coordY').val()-offset;
                $('input#coordY').val(thisY);
                change(false,false,thisY);
            }

            var change = function (op, left, top) {

                chrome.tabs.executeScript(null, { code: "opacity=" + op + ";left=" + left + "; xtop=" + top + ";" }, function () {
                    chrome.tabs.executeScript(null, { file: "settings.js" }, function () {
                        chrome.tabs.executeScript(null, { code: "onOverlayUpdate();" });
                    });
                });
            }
            
//            var showOverlay = function(thisOpacity) {
//                chrome.tabs.executeScript(null, { file: "jquery-1.6.2.min.js" }, function() {
//                    chrome.tabs.executeScript(null, { file: "jquery-ui-1.8.16.custom.min.js" }, function() {
//                            chrome.tabs.executeScript(null, {code: "var opacity = "+thisOpacity},function(){
//                                chrome.tabs.executeScript(null, {file: "content.js"},function(){});
//                            });
//                        });
//                });
//            }
        </script>
    </body>
</html>
