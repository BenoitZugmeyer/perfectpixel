<!DOCTYPE html>
<html>
    <head>
        <script src="jquery-1.6.2.min.js" type="text/javascript"></script>
        <script src="images.js" type="text/javascript"></script>
    </head>
    <body>
        Opacity: <a href="" id="opless" class="ppbutton"><</a>
                 <input type="text" id="opacity" size="1" maxlength="3" value="0.5" readonly/>
                 <a href="" id="opmore" class="ppbutton">></a><br/>
        X: <a href="" id="xless" class="ppbutton"><</a>
           <input type="text" class="coords" id="coordX" value="50" size="2" maxlength="4"/>
           <a href="" id="xmore" class="ppbutton">></a><br/>
        Y:  <a href="" id="yless" class="ppbutton"><</a>
            <input type="text" class="coords" id="coordY" value="50" size="2" maxlength="4"/>
            <a href="" id="ymore" class="ppbutton">></a>

        <div>
            <input type="file" onchange="upload(this.files)" accept="image/*" />
            <img id="thumb" />
            <div>
                <input type="button" value="Show/Hide" onclick="toggleOverlay1(false);" />
            </div>
        </div>
        <script type="text/javascript">
            chrome.tabs.executeScript(null, { file: "jquery-1.6.2.min.js" }, function () {
                chrome.tabs.executeScript(null, { file: "jquery-ui-1.8.16.custom.min.js" }, function () {
                    chrome.tabs.executeScript(null, { file: "content.js" }, function () {
                        chrome.tabs.executeScript(null, { file: "images.js" });
                    });
                });
            });

            $(function () {
                showThumb();
                // set inputs values
                refreshCoords();
            });

            var showThumb = function () {
                var thumbHeight = 50;
                var overlay = PPStorage.GetOverlay();
                if (overlay != null) {
                    var coeff = overlay.Height / thumbHeight;
                    var thumbWidth = Math.ceil(overlay.Width / coeff);

                    $('#thumb').attr('src', overlay.Url).css('width', thumbWidth + 'px').css('height', thumbHeight + 'px');
                }
            }

            var refreshCoords = function () {
                var overlay = PPStorage.GetOverlay();
                if (overlay != null) {
                    $('#coordX').val(overlay.X);
                    $('#coordY').val(overlay.Y);
                    $('#opacity').val(Number(overlay.Opacity).toFixed(1));
                }
            }

            function upload(files) {
                file = files[0];

//                for (var i = 0; i < files.length; i++) {
//                    file = files[i];
//                    if (window.createObjectURL) {
//                        url = window.createObjectURL(file)
//                    } else if (window.createBlobURL) {
//                        url = window.createBlobURL(file)
//                    } else if (window.URL && window.URL.createObjectURL) {
//                        url = window.URL.createObjectURL(file)
//                    } else if (window.webkitURL && window.webkitURL.createObjectURL) {
//                        url = window.webkitURL.createObjectURL(file)
//                    }
//                }

                PPStorage.SaveOverlayFromFile(file,
                    function () {
                        refreshCoords();
                        showThumb();
                        toggleOverlay1(true);
                    });
            }

            function toggleOverlay1(createOnly) {
                var overlay = PPStorage.GetOverlay();
                if (overlay == null)
                    return;

                var funcName = createOnly ? "createOverlay" : "toggleOverlay";
                chrome.tabs.executeScript(null, {
                    code:
                        funcName + "(); $('#overlay_3985123731465987').attr('src', ''); $('#overlay_3985123731465987').attr('src', '" + overlay.Url + "')" + //";"
                                ".css('width','" + overlay.Width + "px').css('height','" + overlay.Height + "px')" +
                                ".css('left','" + overlay.X + "px').css('top','" + overlay.Y + "px')" +
                                ".css('opacity'," + overlay.Opacity + ");"
                });
            }

        </script>
        <script type="text/javascript">
//            chrome.extension.onRequest.addListener(
//                function(request,sender,sendResponse){
//                    alert(request.coordX);
//                }
//            );
            
            $('.ppbutton').live("click",function(event){
                event.preventDefault();
                if($(this).attr('id')=="opless" || $(this).attr('id')=="opmore"){
                    opacity($(this));
                }
                if($(this).attr('id')=="xless" || $(this).attr('id')=="xmore"){
                    xleft($(this));
                }
                if($(this).attr('id')=="yless" || $(this).attr('id')=="ymore"){
                   xtop($(this));
                }
            });

            $('.coords').live("keypress", function (event) {
                if (event.which == 13) {
                    if ($(this).attr("id") == "coordX")
                        change(false, $(this).val(), false);
                    if ($(this).attr("id") == "coordY")
                        change(false, false, $(this).val());
                }
            });

            var opacity = function(button){
                var offset=0;
                if(button.attr('id') == "opless"){ 
                    if($('input#opacity').val()>=0.11)
                        offset= 0.1;
                    else offset = 0;
                }
                else{
                    if($('input#opacity').val()<=0.99)
                        offset = -0.1;
                    else offset = 0;
                }
                var thisOpacity = Number($('input#opacity').val() - offset).toFixed(1);
                $('input#opacity').val(thisOpacity);
                change(thisOpacity,false,false);
            }
            
            var xleft = function(button){
                var offset=0;
                if(button.attr('id') == "xless"){ 
                    if($('input#coordX').val()>=0)
                        offset= 1;
                    else offset = 0;
                }
                else{
                    offset = -1;
                }
                var thisX = $('input#coordX').val()-offset;
                $('input#coordX').val(thisX);
                change(false,thisX,false);
            }
            
            var xtop = function(button){
                var offset=0;
                if(button.attr('id') == "yless"){ 
                    if($('input#coordY').val()>=0)
                        offset= 1;
                    else offset = 0;
                }
                else{
                    offset = -1;
                }
                var thisY = $('input#coordY').val()-offset;
                $('input#coordY').val(thisY);
                change(false,false,thisY);
            }

            var change = function (op, left, top) {

                chrome.tabs.executeScript(null, { code: "opacity=" + op + ";left=" + left + "; xtop=" + top + ";" }, function () {
                    chrome.tabs.executeScript(null, { file: "settings.js" }, function () {
                        chrome.tabs.executeScript(null, { code: "onOverlayUpdate();" });
                    });
                });
            }
            
//            var showOverlay = function(thisOpacity) {
//                chrome.tabs.executeScript(null, { file: "jquery-1.6.2.min.js" }, function() {
//                    chrome.tabs.executeScript(null, { file: "jquery-ui-1.8.16.custom.min.js" }, function() {
//                            chrome.tabs.executeScript(null, {code: "var opacity = "+thisOpacity},function(){
//                                chrome.tabs.executeScript(null, {file: "content.js"},function(){});
//                            });
//                        });
//                });
//            }
        </script>
    </body>
</html>
