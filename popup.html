<!DOCTYPE html>
<html>
    <head>
        <script src="jquery-1.6.2.min.js"></script>
    </head>
    <body>
        Opacity: <a href="" id="opless" class="ppbutton"><</a>
                 <input type="text" id="opacity" size="1" maxlength="3" value="0.5" readonly/>
                 <a href="" id="opmore" class="ppbutton">></a><br/>
        X: <a href="" id="xless" class="ppbutton"><</a>
           <input type="text" class="coords" id="coordX" value="50" size="2" maxlength="4"/>
           <a href="" id="xmore" class="ppbutton">></a><br/>
        Y:  <a href="" id="yless" class="ppbutton"><</a>
            <input type="text" class="coords" id="coordY" value="50" size="2" maxlength="4"/>
            <a href="" id="ymore" class="ppbutton">></a>

        <div>
            <input type="file" onchange="upload(this.files)" accept="image/*" />
            <img id="thumb" />
            <div>
                <input type="button" value="Show/Hide" onclick="toggleOverlay1(false);" />
            </div>
        </div>
        <script type="text/javascript">
            chrome.tabs.executeScript(null, { file: "jquery-1.6.2.min.js" }, function () {
                chrome.tabs.executeScript(null, { file: "jquery-ui-1.8.16.custom.min.js" }, function () {
                    chrome.tabs.executeScript(null, { file: "content.js" });
                });
            });

//            var getBase64Image = function (img) {
//                // Create an empty canvas element
//                var canvas = document.createElement("canvas");
//                canvas.width = img.width;
//                canvas.height = img.height;

//                // Copy the image contents to the canvas
//                var ctx = canvas.getContext("2d");
//                ctx.drawImage(img, 0, 0);

//                // Get the data-URL formatted image
//                // Firefox supports PNG and JPEG. You could check img.src to
//                // guess the original format, but be aware the using "image/jpg"
//                // will re-encode the image.
//                var dataURL = canvas.toDataURL("image/jpg");

//                return dataURL;
//            }


            // Save image into localStorage
            var saveImage = function (file, callback) {

                // Only process image files.
                if (!file.type.match('image.*')) {
                    alert('File must contain image');
                }

                var reader = new FileReader();

                // Closure to capture the file information.
                reader.onload = (function (theFile) {
                    return function (e) {
                        localStorage["imageData"] = null;
                        localStorage["imageData"] = e.target.result;

                        // Render thumbnail.
                        var span = $('<span></span>').css('position', 'absolute').css('opacity', 0);
                        var img = $('<img />').attr({
                            src: e.target.result,
                            title: theFile.name
                        });
                        span.append(img);
                        $(document.body).append(span);

                        img.load(function () {
                            localStorage["imageWidth"] = img[0].offsetWidth;
                            localStorage["imageHeight"] = img[0].offsetHeight;
                            span.remove();
                            callback();
                        });
                    };
                })(file);

                // Read in the image file as a data URL.
                reader.readAsDataURL(file);

                //                var xhr = new XMLHttpRequest();
                //                xhr.open('GET', 'http://www.renderedsource.com/alex/img/small.jpg', true);

                //                xhr.responseType = 'arraybuffer';

                //                xhr.onload = function (e) {
                //                    if (this.status == 200) {

                //                        var uInt8Array = new Uint8Array(this.response); // Note: not xhr.responseText
                //                        //"data:image/png;base64,"
                //                    }
                //                };

                //                xhr.send();
                //                var img = $("<img src='" + url + "' />");
                //                img.load(function () {
                //                    var imageData = getBase64Image(this);
                //                    localStorage["imageData"] = null;
                //                    localStorage["imageData"] = imageData;
                //                    localStorage["imageWidth"] = img[0].width;
                //                    localStorage["imageHeight"] = img[0].height;
                //                    callback();
                //                });
            }

            var showThumb = function () {
                var thumbHeight = 50;

                if (localStorage["imageData"]) {
                    var imageData = localStorage["imageData"];
                    var width = localStorage["imageWidth"];
                    var height = localStorage["imageHeight"];
                    var coeff = height / thumbHeight;
                    var thumbWidth = Math.ceil(width / coeff);

                    $('#thumb').attr('src', imageData).css('width', thumbWidth + 'px').css('height', thumbHeight + 'px');
                }
            }

            $(function () {
                showThumb();
            });

            function upload(files) {
                file = files[0];

//                for (var i = 0; i < files.length; i++) {
//                    file = files[i];
//                    if (window.createObjectURL) {
//                        url = window.createObjectURL(file)
//                    } else if (window.createBlobURL) {
//                        url = window.createBlobURL(file)
//                    } else if (window.URL && window.URL.createObjectURL) {
//                        url = window.URL.createObjectURL(file)
//                    } else if (window.webkitURL && window.webkitURL.createObjectURL) {
//                        url = window.webkitURL.createObjectURL(file)
//                    }
//                }

                saveImage(file,
                    function () {
                        showThumb();
                        toggleOverlay1(true);
                    });
            }

            function toggleOverlay1(createOnly) {
                if (!localStorage["imageData"])
                    return;

                var imageData = localStorage["imageData"];
                var width = localStorage["imageWidth"];
                var height = localStorage["imageHeight"];

                var funcName = createOnly ? "createOverlay" : "toggleOverlay";
                chrome.tabs.executeScript(null, {
                    code:
                        funcName + "(); $('#overlay_3985123731465987').attr('src', ''); $('#overlay_3985123731465987').attr('src', '" + imageData + "')" + //";"
                                ".css('width','" + width + "px').css('height','" + height + "px');"
                });
            }

        </script>
        <script type="text/javascript">
//            chrome.extension.onRequest.addListener(
//                function(request,sender,sendResponse){
//                    alert(request.coordX);
//                }
//            );
            
            $('.ppbutton').live("click",function(event){
                event.preventDefault();
                if($(this).attr('id')=="opless" || $(this).attr('id')=="opmore"){
                    opacity($(this));
                }
                if($(this).attr('id')=="xless" || $(this).attr('id')=="xmore"){
                    xleft($(this));
                }
                if($(this).attr('id')=="yless" || $(this).attr('id')=="ymore"){
                   xtop($(this));
                }
            });

            $('.coords').live("keypress", function (event) {
                if (event.which == 13) {
                    if ($(this).attr("id") == "coordX")
                        change(false, $(this).val(), false);
                    if ($(this).attr("id") == "coordY")
                        change(false, false, $(this).val());
                }
            });

            var opacity = function(button){
                var offset=0;
                if(button.attr('id') == "opless"){ 
                    if($('input#opacity').val()>=0.11)
                        offset= 0.1;
                    else offset = 0;
                }
                else{
                    if($('input#opacity').val()<=0.99)
                        offset = -0.1;
                    else offset = 0;
                }
                var thisOpacity = Number($('input#opacity').val() - offset).toFixed(1);
                $('input#opacity').val(thisOpacity);
                change(thisOpacity,false,false);
            }
            
            var xleft = function(button){
                var offset=0;
                if(button.attr('id') == "xless"){ 
                    if($('input#coordX').val()>=0)
                        offset= 1;
                    else offset = 0;
                }
                else{
                    offset = -1;
                }
                var thisX = $('input#coordX').val()-offset;
                $('input#coordX').val(thisX);
                change(false,thisX,false);
            }
            
            var xtop = function(button){
                var offset=0;
                if(button.attr('id') == "yless"){ 
                    if($('input#coordY').val()>=0)
                        offset= 1;
                    else offset = 0;
                }
                else{
                    offset = -1;
                }
                var thisY = $('input#coordY').val()-offset;
                $('input#coordY').val(thisY);
                change(false,false,thisY);
            }
            
            var change = function(op,left,top) {
                chrome.tabs.executeScript(null, { code: "opacity="+op+";left="+left+"; xtop="+top+";"}, function() {
                   chrome.tabs.executeScript(null, { file: "settings.js" }, function() {
                       
                   });
                });
            }
            
//            var showOverlay = function(thisOpacity) {
//                chrome.tabs.executeScript(null, { file: "jquery-1.6.2.min.js" }, function() {
//                    chrome.tabs.executeScript(null, { file: "jquery-ui-1.8.16.custom.min.js" }, function() {
//                            chrome.tabs.executeScript(null, {code: "var opacity = "+thisOpacity},function(){
//                                chrome.tabs.executeScript(null, {file: "content.js"},function(){});
//                            });
//                        });
//                });
//            }
        </script>
    </body>
</html>
