<!DOCTYPE html>
<html>
    <head>
        <script src="jquery-1.6.2.min.js"></script>
    </head>
    <body>
        Opacity: <a href="" id="opless" class="ppbutton"><</a>
                 <input type="text" id="opacity" size="1" maxlength="3" value="0.5" readonly/>
                 <a href="" id="opmore" class="ppbutton">></a><br/>
        X: <a href="" id="xless" class="ppbutton"><</a>
           <input type="text" id="coordX" value="50" size="2" maxlength="4"/>
           <a href="" id="xmore" class="ppbutton">></a><br/>
        Y:  <a href="" id="yless" class="ppbutton"><</a>
            <input type="text" id="coordY" value="50" size="2" maxlength="4"/>
            <a href="" id="ymore" class="ppbutton">></a>

        <div>
            <input type="file" onchange="upload(this.files)" />
            <img id="thumb" style="width: 50px; height: 50px" />
            <div>
                <input type="button" value="Show/Hide" onclick="toggleOverlay1(false);" />
            </div>
        </div>
        <script type="text/javascript">
            chrome.tabs.executeScript(null, { file: "jquery-1.6.2.min.js" }, function () {
                chrome.tabs.executeScript(null, { file: "jquery-ui-1.8.16.custom.min.js" }, function () {
                    chrome.tabs.executeScript(null, { file: "content.js" });
                });
            });

            var getBase64Image = function (img) {
                // Create an empty canvas element
                var canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;

                // Copy the image contents to the canvas
                var ctx = canvas.getContext("2d");
                //ctx.scale(0.835, 0.835);
                ctx.drawImage(img, 0, 0);

                // Get the data-URL formatted image
                // Firefox supports PNG and JPEG. You could check img.src to
                // guess the original format, but be aware the using "image/jpg"
                // will re-encode the image.
                var dataURL = canvas.toDataURL("image/jpg");

                return dataURL;
            }


            // Save image by Url into localStorage
            var saveImage = function (url, callback) {
                var img = $("<img src='" + url + "' />");
                img.load(function () {
                    var imageData = getBase64Image(this);
                    localStorage["imageData"] = imageData;
                    localStorage["imageWidth"] = img[0].width;
                    localStorage["imageHeight"] = img[0].height;
                    callback();
                });
            }

            var showThumb = function () {
                if (localStorage["imageData"]) {
                    var imageData = localStorage["imageData"];
                    $('#thumb').attr('src', imageData);
                }
            }

            $(function () {
                showThumb();
            });

            function upload(files) {
                for (var i = 0; i < files.length; i++) {
                    var url, file = files[i];
                    if (window.createObjectURL) {
                        url = window.createObjectURL(file)
                    } else if (window.createBlobURL) {
                        url = window.createBlobURL(file)
                    } else if (window.URL && window.URL.createObjectURL) {
                        url = window.URL.createObjectURL(file)
                    } else if (window.webkitURL && window.webkitURL.createObjectURL) {
                        url = window.webkitURL.createObjectURL(file)
                    }
                }

                saveImage(url,
                    function () {
                        showThumb();
                        toggleOverlay1(true);
                    });
            }

            function toggleOverlay1(createOnly) {
                if (!localStorage["imageData"])
                    return;

                var imageData = localStorage["imageData"];
                var width = localStorage["imageWidth"];
                var height = localStorage["imageHeight"];

                var funcName = createOnly ? "createOverlay" : "toggleOverlay";
                chrome.tabs.executeScript(null, {
                    code:
                        funcName + "(); $('#overlay_3985123731465987').attr('src', ''); $('#overlay_3985123731465987').attr('src', '" + imageData + "')" + //";"
                                ".css('width','" + width + "px').css('height','" + height + "px');"
                });
            }

        </script>
        <script>
//            chrome.extension.onRequest.addListener(
//                function(request,sender,sendResponse){
//                    alert(request.coordX);
//                }
//            );
            
            $('.ppbutton').live("click",function(event){
                event.preventDefault();
                if($(this).attr('id')=="opless" || $(this).attr('id')=="opmore"){
                    opacity($(this));
                }
                if($(this).attr('id')=="xless" || $(this).attr('id')=="xmore"){
                    xleft($(this));
                }
                if($(this).attr('id')=="yless" || $(this).attr('id')=="ymore"){
                   xtop($(this));
                }
            });
            
            var opacity = function(button){
                var offset=0;
                if(button.attr('id') == "opless"){ 
                    if($('input#opacity').val()>=0)
                        offset= 0.1;
                    else offset = 0;
                }
                else{
                    if($('input#opacity').val()<=1)
                        offset = -0.1;
                    else offset = 0;
                }
                var thisOpacity = $('input#opacity').val()-offset;
                $('input#opacity').val(thisOpacity);
                change(thisOpacity,false,false);
            }
            
            var xleft = function(button){
                var offset=0;
                if(button.attr('id') == "xless"){ 
                    if($('input#coordX').val()>=0)
                        offset= 1;
                    else offset = 0;
                }
                else{
                    offset = -1;
                }
                var thisX = $('input#coordX').val()-offset;
                $('input#coordX').val(thisX);
                change(false,thisX,false);
            }
            
            var xtop = function(button){
                var offset=0;
                if(button.attr('id') == "yless"){ 
                    if($('input#coordY').val()>=0)
                        offset= 1;
                    else offset = 0;
                }
                else{
                    offset = -1;
                }
                var thisY = $('input#coordY').val()-offset;
                $('input#coordY').val(thisY);
                change(false,false,thisY);
            }
            
            var change = function(op,left,top){
                chrome.tabs.executeScript(null, { code: "opacity="+op+";left="+left+"; xtop="+top+";"}, function() {
                   chrome.tabs.executeScript(null, { file: "settings.js" }, function() {
                       
                   });
                });
            }
            
//            var showOverlay = function(thisOpacity) {
//                chrome.tabs.executeScript(null, { file: "jquery-1.6.2.min.js" }, function() {
//                    chrome.tabs.executeScript(null, { file: "jquery-ui-1.8.16.custom.min.js" }, function() {
//                            chrome.tabs.executeScript(null, {code: "var opacity = "+thisOpacity},function(){
//                                chrome.tabs.executeScript(null, {file: "content.js"},function(){});
//                            });
//                        });
//                });
//            }
        </script>
    </body>
</html>
