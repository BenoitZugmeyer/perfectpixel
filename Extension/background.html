<script src="pp-shared.js" type="text/javascript"></script>
<script src="storage/filemanager.js" type="text/javascript"></script>

<script type="text/javascript">

//    PPFileManager.Init(function () {
//        PPFileManager.DeleteAllFiles();
//    });
    
    //React when a browser action's icon is clicked.
    chrome.browserAction.onClicked.addListener(function (tab) {
        

        chrome.tabs.insertCSS(tab.id, { file: "style.css" });
        chrome.tabs.insertCSS(tab.id, { file: "jquery-ui-1.8.16.custom.css" });
        chrome.tabs.executeScript(null, { file: "jquery-1.6.2.min.js" }, function () {
            chrome.tabs.executeScript(null, { file: "jquery-ui-1.8.16.custom.min.js" }, function () {
                //chrome.tabs.executeScript(null, { file: "pp-shared.js" }, function () {
                    //chrome.tabs.executeScript(null, { file: "storage/filemanager.js" }, function () {
                        //chrome.tabs.executeScript(null, { file: "storage/pp-storage-filesystem.js" }, function () {
                            //chrome.tabs.executeScript(null, { file: "storage/pp-storage-localStorage.js" }, function () {
                                //chrome.tabs.executeScript(null, { file: "pp-content.js" }, function () {
                                    chrome.tabs.executeScript(null, { code: "togglePanel();" });
                                //});
                            //});
                        //});
                    //});
                //});
            });
        });
    });

    chrome.extension.onRequest.addListener(
        function (request, sender, sendResponse) {
            console.log(sender.tab ?
                    "from a content script:" + sender.tab.url :
                    "from the extension");

            PPFileManager.Init(function () {
                if (request.type == PP_RequestType.GETFILE) {
                    // GETGILE handler

                    var fileName = request.fileName;

                    PPFileManager.GetFile(fileName, function (ppFile) {
                        sendPPFileResponse(ppFile, sendResponse);
                    });
                }
                else if (request.type == PP_RequestType.ADDFILE) {
                    // ADDFILE handler

                    var ppFile = new PPFile();
                    ppFile.ArrayBuffer = stringToBuffer(request.fileData);
                    ppFile.Name = request.fileName;
                    ppFile.MimeType = request.fileType;

                    PPFileManager.SaveFile(ppFile, function (ppFileOut) {
                        sendPPFileResponse(ppFileOut, sendResponse);
                    });
                }
                else if (request.type == PP_RequestType.DELETEFILE) {
                    // DELETEFILE handler

                    var fileName = request.fileName;

                    PPFileManager.DeleteFile(fileName, function () {
                        sendResponse({
                            status: "OK"
                        });
                    });
                }
            });
        });

      function sendPPFileResponse(ppFile, sendResponse) {
          sendResponse(
            {
                status: "OK",
                fileName: ppFile.Name,
                fileType: ppFile.MimeType,
                arrayBuffer: bufferToString(ppFile.ArrayBuffer)
            });
      }
 </script>